# üìä M√≥dulo de Gesti√≥n de Cobros

## üéØ Descripci√≥n

M√≥dulo completo para la gesti√≥n de cobros del sistema. Permite a los vendedores registrar sus cobros y a los administradores controlar cu√°les han sido cargados en el sistema de facturaci√≥n externo.

---

## üë• Roles y Permisos

### **Vendedores (Santi / Guille)**
- ‚úÖ Crear nuevos cobros
- ‚úÖ Editar sus propios cobros (solo si est√°n en estado "Pendiente")
- ‚úÖ Ver solo sus propios cobros
- ‚úÖ Ver el estado de sus cobros (Pendiente/Cargado)
- ‚úÖ Acceso al dashboard con sus m√©tricas

### **Administrador**
- ‚úÖ Ver todos los cobros de todos los vendedores
- ‚úÖ Editar cualquier cobro
- ‚úÖ Eliminar cobros
- ‚úÖ Marcar cobros como "Cargado en sistema"
- ‚úÖ Revertir estado a "Pendiente"
- ‚úÖ Acceso completo al dashboard
- ‚úÖ Acceso a logs de auditor√≠a

---

## üìã Estructura de Datos

### Colecci√≥n: `cobros`

```javascript
{
  id: "auto-generado",
  cliente: "Nombre del cliente",
  clienteId: "id_cliente",
  monto: 150000,
  fechaCobro: Timestamp,
  formaPago: "efectivo" | "transferencia" | "otro",
  notas: "Informaci√≥n adicional",
  estado: "pendiente" | "cargado",
  fechaCargaSistema: Timestamp,
  cargadoPor: "admin@email.com",
  vendedor: "vendedor@email.com",
  createdAt: Timestamp,
  updatedAt: Timestamp,
  createdBy: "email",
  updatedBy: "email"
}
```

### Colecci√≥n: `cobros_logs`

```javascript
{
  id: "auto-generado",
  cobroId: "id_del_cobro",
  usuario: "email",
  accion: "crear" | "editar" | "eliminar" | "marcar_cargado" | "marcar_pendiente",
  cambios: {
    anterior: {...},
    nuevo: {...}
  },
  timestamp: Timestamp,
  ip: "localhost",
  userAgent: "..."
}
```

---

## üóÇÔ∏è Estructura de Archivos

```
src/features/cobros/
‚îú‚îÄ‚îÄ CobrosMain.jsx           # Componente principal con tabs
‚îú‚îÄ‚îÄ CobroForm.jsx            # Formulario crear/editar cobro
‚îú‚îÄ‚îÄ CobrosLista.jsx          # Lista de cobros con filtros
‚îú‚îÄ‚îÄ CobrosDashboard.jsx      # Dashboard con m√©tricas y gr√°ficos
‚îú‚îÄ‚îÄ CobrosLogs.jsx           # Sistema de auditor√≠a
‚îú‚îÄ‚îÄ cobrosService.js         # Servicios Firebase
‚îú‚îÄ‚îÄ constants.js             # Constantes del m√≥dulo
‚îú‚îÄ‚îÄ utils.js                 # Funciones utilitarias
‚îú‚îÄ‚îÄ index.js                 # Exports del m√≥dulo
‚îî‚îÄ‚îÄ README_COBROS.md         # Esta documentaci√≥n
```

---

## üöÄ Funcionalidades

### 1. **Lista de Cobros** (`CobrosLista.jsx`)

#### Caracter√≠sticas:
- ‚úÖ DataTable con paginaci√≥n
- ‚úÖ B√∫squeda global en tiempo real
- ‚úÖ Filtros avanzados:
  - Por estado (Pendiente/Cargado)
  - Por forma de pago
  - Por rango de fechas
- ‚úÖ Exportar a CSV
- ‚úÖ Acciones contextuales seg√∫n rol
- ‚úÖ Actualizaci√≥n en tiempo real (Firebase Realtime)

#### Columnas:
- Fecha del cobro
- Cliente
- Monto (formateado con $)
- Forma de pago
- Vendedor (solo visible para admin)
- Estado (badge con color)
- Notas
- Acciones

#### Acciones disponibles:
- **Editar** (solo si es tu cobro o eres admin, y est√° pendiente)
- **Marcar como Cargado** (solo admin)
- **Revertir a Pendiente** (solo admin)
- **Eliminar** (solo admin)

---

### 2. **Dashboard** (`CobrosDashboard.jsx`)

#### Tarjetas de Resumen:
1. **Total Cobrado** - Suma de todos los cobros
2. **Pendiente** - Suma de cobros no cargados
3. **Cargado** - Suma de cobros ya en el sistema
4. **Total Cobros** - Cantidad de registros

#### Gr√°ficos:
1. **Distribuci√≥n por Estado** (Doughnut Chart)
   - Pendiente vs Cargado
   
2. **Por Forma de Pago** (Bar Chart)
   - Efectivo, Transferencia, Otro

3. **Por Vendedor** (Horizontal Bar Chart - solo admin)
   - Total cobrado por cada vendedor

#### Filtro de Per√≠odo:
- Hoy
- Esta Semana
- Este Mes
- Este A√±o
- Todo

#### Barra de Progreso:
- Porcentaje de cobros cargados en el sistema

---

### 3. **Formulario de Cobro** (`CobroForm.jsx`)

#### Campos:
- **Cliente*** (obligatorio) - InputText
- **Monto*** (obligatorio) - InputNumber con formato de moneda
- **Fecha del Cobro*** (obligatorio) - Calendar
- **Forma de Pago*** (obligatorio) - Dropdown
  - Efectivo
  - Transferencia
  - Otro
- **Notas** (opcional) - Textarea

#### Validaciones:
- Cliente no puede estar vac√≠o
- Monto debe ser mayor a 0
- Fecha es requerida
- Forma de pago es requerida

#### Informaci√≥n adicional (solo en edici√≥n):
- Vendedor que cre√≥ el cobro
- Estado actual del cobro

---

### 4. **Sistema de Auditor√≠a** (`CobrosLogs.jsx`)

#### Caracter√≠sticas:
- ‚úÖ Vista de tabla y timeline
- ‚úÖ Registro de todas las acciones
- ‚úÖ B√∫squeda y filtrado
- ‚úÖ Actualizaci√≥n en tiempo real

#### Acciones registradas:
- Crear cobro
- Editar cobro
- Eliminar cobro
- Marcar como cargado
- Marcar como pendiente

#### Informaci√≥n registrada:
- Fecha y hora exacta
- Usuario que realiz√≥ la acci√≥n
- Tipo de acci√≥n
- Cambios realizados (antes/despu√©s)
- IP y User Agent

---

## üîß Servicios Principales

### `cobrosService.js`

#### Funciones disponibles:

```javascript
// Obtener cobros
getCobros()
getCobrosRealtime(callback)
getCobrosByVendedor(vendedorEmail)
getCobrosByVendedorRealtime(vendedorEmail, callback)
getCobroById(cobroId)

// CRUD
crearCobro(cobroData, usuario)
actualizarCobro(cobroId, cobroData, usuario)
eliminarCobro(cobroId, usuario)

// Cambio de estado
marcarComoCargado(cobroId, usuario)
marcarComoPendiente(cobroId, usuario)

// Auditor√≠a
getLogs(cobroId?)
getLogsRealtime(callback, cobroId?)
crearLog(logData)
```

---

## üé® Utilidades

### `utils.js`

Funciones de formateo y validaci√≥n:

```javascript
// Formateo
formatearMonto(monto)           // $150.000
formatearFecha(fecha)           // 14/10/2025
formatearFechaHora(fecha)       // 14/10/2025 10:30
getFormaPagoLabel(valor)
getEstadoLabel(estado)
getAccionLabel(accion)

// Validaciones
validarMonto(monto)
validarFecha(fecha)
validarCliente(cliente)
validarFormaPago(formaPago)

// C√°lculos
calcularTotalesPorEstado(cobros)
calcularTotalesPorVendedor(cobros)
calcularTotalesPorFormaPago(cobros)

// Filtros
filtrarPorRangoFechas(cobros, fechaInicio, fechaFin)

// Export
exportarCobrosCsv(cobros)
descargarCsv(contenido, nombreArchivo)
```

---

## üìä Constantes

### Formas de Pago
```javascript
FORMAS_PAGO = [
  { label: 'Efectivo', value: 'efectivo' },
  { label: 'Transferencia', value: 'transferencia' },
  { label: 'Otro', value: 'otro' }
]
```

### Estados
```javascript
ESTADOS_COBRO = {
  PENDIENTE: 'pendiente',
  CARGADO: 'cargado'
}

ESTADO_COLORS = {
  pendiente: 'warning',
  cargado: 'success'
}

ESTADO_ICONS = {
  pendiente: 'pi pi-clock',
  cargado: 'pi pi-check-circle'
}
```

---

## üîÑ Flujo de Trabajo

### Para Vendedores:

1. **Registrar Cobro**
   - Click en "Nuevo Cobro"
   - Completar formulario
   - Guardar

2. **Verificar Estado**
   - Ver lista de cobros
   - Identificar cu√°les est√°n "Pendientes" (amarillo)
   - Identificar cu√°les est√°n "Cargados" (verde)

3. **Editar Cobro**
   - Solo posible si est√° "Pendiente"
   - Click en √≠cono de editar
   - Modificar y guardar

### Para Administradores:

1. **Revisar Cobros Pendientes**
   - Filtrar por estado "Pendiente"
   - Verificar en sistema de facturaci√≥n externo

2. **Marcar como Cargado**
   - Click en √≠cono de check (‚úì)
   - El cobro cambia a estado "Cargado"
   - Se registra qui√©n y cu√°ndo lo marc√≥

3. **Revertir si es necesario**
   - Click en √≠cono de refresh
   - Vuelve a estado "Pendiente"

4. **Control y Auditor√≠a**
   - Ver dashboard con m√©tricas
   - Revisar logs para auditor√≠a
   - Exportar reportes en CSV

---

## üéØ Casos de Uso

### Caso 1: Vendedor registra un cobro
```
Usuario: Santi
Acci√≥n: Crear nuevo cobro
Cliente: "Distribuidora ABC"
Monto: $250.000
Forma de pago: Transferencia
Resultado: Cobro creado en estado "Pendiente"
```

### Caso 2: Admin marca cobro como cargado
```
Usuario: Admin
Acci√≥n: Marcar como cargado
Cobro: ID abc123
Resultado: Estado cambia a "Cargado", se registra fecha y usuario
```

### Caso 3: Doble control
```
1. Vendedor revisa sus cobros
2. Ve que 5 est√°n "Pendientes" y 3 "Cargados"
3. Confirma con admin que los 3 cargados est√°n correctos
4. Admin verifica en sistema externo
```

---

## üîê Seguridad

- ‚úÖ Validaci√≥n de permisos por rol
- ‚úÖ Reglas de Firestore para proteger datos
- ‚úÖ Auditor√≠a completa de todas las acciones
- ‚úÖ Timestamps de creaci√≥n y modificaci√≥n
- ‚úÖ Registro de qui√©n hizo cada cambio

---

## üöß Reglas de Firestore Sugeridas

```javascript
// firestore.rules
match /cobros/{cobroId} {
  // Leer: vendedor solo sus cobros, admin todos
  allow read: if request.auth != null && 
    (resource.data.vendedor == request.auth.token.email || 
     get(/databases/$(database)/documents/usuarios/$(request.auth.token.email)).data.role == 'admin');
  
  // Crear: usuarios autenticados
  allow create: if request.auth != null && 
    request.resource.data.vendedor == request.auth.token.email;
  
  // Actualizar: solo admin o vendedor del cobro (si est√° pendiente)
  allow update: if request.auth != null && 
    (get(/databases/$(database)/documents/usuarios/$(request.auth.token.email)).data.role == 'admin' ||
     (resource.data.vendedor == request.auth.token.email && resource.data.estado == 'pendiente'));
  
  // Eliminar: solo admin
  allow delete: if request.auth != null && 
    get(/databases/$(database)/documents/usuarios/$(request.auth.token.email)).data.role == 'admin';
}

match /cobros_logs/{logId} {
  // Solo lectura para usuarios autenticados
  allow read: if request.auth != null;
  // Solo escritura desde el servidor o admin
  allow create: if request.auth != null;
}
```

---

## üì± Responsive Design

El m√≥dulo est√° completamente adaptado para:
- üíª Desktop
- üì± Tablet
- üì± Mobile

---

## üé® Tecnolog√≠as Utilizadas

- **React** - Framework principal
- **PrimeReact** - Componentes UI
- **Firebase Firestore** - Base de datos en tiempo real
- **Moment.js** - Manejo de fechas
- **Chart.js** (via PrimeReact) - Gr√°ficos

---

## ‚úÖ Caracter√≠sticas Destacadas

- ‚ö° **Actualizaci√≥n en tiempo real** - Los cambios se ven instant√°neamente
- üîç **B√∫squeda y filtros potentes** - Encuentra cualquier cobro r√°pidamente
- üìä **Dashboard visual** - M√©tricas claras y gr√°ficos informativos
- üìù **Auditor√≠a completa** - Trazabilidad total de todas las acciones
- üéØ **Control de permisos** - Cada usuario ve y hace solo lo que debe
- üì§ **Exportaci√≥n** - Descarga reportes en CSV
- üé® **Interfaz moderna** - Dise√±o limpio y profesional

---

## üêõ Manejo de Errores

Todos los errores se manejan con:
- Mensajes Toast informativos
- Console.error para debugging
- Try-catch en todas las operaciones as√≠ncronas

---

## üìù Notas Importantes

1. **Estado Pendiente**: Los cobros reci√©n creados siempre inician en estado "Pendiente"
2. **Edici√≥n limitada**: Solo se pueden editar cobros en estado "Pendiente"
3. **Permisos**: El vendedor solo puede ver y editar sus propios cobros
4. **Auditor√≠a**: Todas las acciones quedan registradas permanentemente
5. **Tiempo real**: Los cambios se sincronizan autom√°ticamente entre usuarios

---

## üîÆ Futuras Mejoras (Sugeridas)

- [ ] Notificaciones push cuando un cobro es marcado como cargado
- [ ] Integraci√≥n directa con el sistema de facturaci√≥n
- [ ] Carga masiva de cobros desde CSV/Excel
- [ ] Adjuntar comprobantes (im√°genes/PDFs)
- [ ] Reportes m√°s avanzados con filtros personalizados
- [ ] Recordatorios autom√°ticos de cobros pendientes
- [ ] Dashboard con tendencias y proyecciones

---

**Desarrollado con ‚ù§Ô∏è para optimizar el proceso de gesti√≥n de cobros**

